name: ubuntu linux x86

on:
  workflow_dispatch:

jobs:
  secure-ssh:
    runs-on: ubuntu-22.04-arm
    timeout-minutes: 3600

    steps:
      - name: Configure SSH Server
        run: |
          # 1. 更新包列表并安装 OpenSSH 服务器
          sudo apt-get update
          sudo apt-get install -y openssh-server

          # 2. 配置 SSH 以允许密码登录（仅为临时调试，生产环境应用密钥）
          sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config

          # 3. 重启 SSH 服务使配置生效
          # 在 Ubuntu 24.04 中，服务名是 `ssh` 而不是 `sshd`
          sudo systemctl restart ssh

          # 4. 检查 SSH 服务状态，确保其正在运行
          sudo systemctl status ssh --no-pager -l

          # 5. 可选：设置 SSH 服务开机自启（在当前临时环境中非必须）
          # sudo systemctl enable ssh

          # 6. 确保防火墙允许 SSH (GitHub Runner 环境通常已开放)
          sudo ufw allow 22/tcp 2>/dev/null || true

      - name: Create SSH User and Set Password
        run: |
          # 生成一个强密码（与你的原逻辑类似）
          PASSWORD=$(openssl rand -base64 32 | tr -d '/+=\n' | head -c 24)
          # 创建用户并设置密码
          sudo useradd -m -s /bin/bash github-ssh
          echo "github-ssh:$PASSWORD" | sudo chpasswd
          # 将用户添加到 sudo 组（可选）
          sudo usermod -aG sudo github-ssh
          
          # 将凭据存入环境变量
          echo "SSH_CREDS=User: github-ssh | Password: $PASSWORD" >> $GITHUB_ENV
          echo "SSH_CREDS_PLAIN=$PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale (ARM64)
        run: |
          # 使用 Tailscale 官方脚本安装，它会自动检测并适配 ARM 架构
          curl -fsSL https://tailscale.com/install.sh | sh
          # 启动 Tailscale 并登录
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-${{ github.run_id }}-arm

      - name: Get Tailscale IP and Verify SSH
        run: |
          # 获取 Tailscale 分配的 IP 地址
          TAILSCALE_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          
          # 简单验证 SSH 端口在本机是否监听
          if ss -tlnp | grep -q ':22 '; then
            echo "SSH server is listening on port 22."
          else
            echo "ERROR: SSH server may not be running."
            exit 1
          fi
          echo "您可以连接: ssh github-ssh@$TAILSCALE_IP"

      - name: Maintain Connection and Output Info
        run: |
          echo "=========================================="
          echo "  ARM Linux SSH 环境已就绪！"
          echo "=========================================="
          echo "连接地址: ${{ env.TAILSCALE_IP }}"
          echo "用户名: github-ssh"
          echo "密码: ${{ env.SSH_CREDS_PLAIN }}"
          echo ""
          echo "连接命令:"
          echo "ssh github-ssh@${{ env.TAILSCALE_IP }}"
          echo "=========================================="
          echo "此工作流将保持运行，直到您手动取消。"
          echo "正在保持活动状态..."

          # 保持工作流活跃的简单循环
          while true; do
            sleep 300
            echo "[$(date)] 运行中..."
          done
